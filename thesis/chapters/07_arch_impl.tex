\chapter{Architecture and implementation}
architecture diagram
design patterns used
(adapter)

\begin{algorithm}[!htp]
\small
\DontPrintSemicolon
\SetKwProg{Fn}{function}{:}{}
\SetKw{return}{return}
\SetKw{break}{break}

\KwIn{$qp$  -- particular query part\;}
\myinput{$w_D$  -- (assigned) particular database wrapper\;}
\myinput{$post$  -- list of postponed statements\;}

\tcp{translation of instructions within the hierarchical structure of a kind, e.g., nesting of properties, filtering (constants), and projection (variables)}
\ForEach{\textup{kind $\kappa$ in $qp$}}{
    \label{algorithm:workflow-III-translation:stepI}
    $STACK$ = empty stack\;
    $STACK$.push($\kappa$.root().identity(), '')\;

    $w_D$.pushKind($\kappa$.name())\;
    \While{\textup{$STACK$ is not empty}}{
        ($m$, $path$) = $STACK$.pop()\;
        $obj$ = $m$.cod()\;
        $path$ = $path$ + $obj$.name()\;
        
        \If{\textup{$obj$ is not FINAL}}{
        \label{algorithm:workflow-III-translation:step9}
            \ForEach{\textup{outgoing morphism $m_{OUT}$ in $obj$.out()}}{
                $STACK$.push($m_{OUT}$, $path$)\;
                \label{algorithm:workflow-III-translation:step11}
            }
        }
        \ElseIf{\textup{$obj$ is CONSTANT}}{
        \label{algorithm:workflow-III-translation:step12}
            processOrPostponeFiltering($w_D$, ('VARIABLE', $\kappa$, $m$, $path$, $\epsilon$), 'equal', ('CONSTANT', $\epsilon$, $\epsilon$, $\epsilon$, $obj$.value()), $post$, 'filtering')\;
            \label{algorithm:workflow-III-translation:step13}
        }
        \Else{
            $w_D$.addProjection($path$, $m$.isOptional())\;
            \label{algorithm:workflow-III-translation:step15}
        }
    }
    $w_D$.popKind()\;\label{algorithm:workflow-III-translation:stepII}
}

\tcp{translation of join candidates}
\ForEach{\textup{joinCandidate $jc$ in $qp$}}{
    \label{algorithm:workflow-III-translation:stepIII}
    \If{\textup{$jc$ is RECURSIVE}}{
    \label{algorithm:workflow-III-translation:step18}
            $w_D$.addRecursiveJoinOrPostpone($jc$.from(), $jc$.to(), $jc$.match(), $jc$.times(), $post$)\;
            \label{algorithm:workflow-III-translation:step19}
    }
    \ElseIf{\textup{$jc$ is OPTIONAL}}{
    \label{algorithm:workflow-III-translation:step20}
            $w_D$.addOptionalJoinOrPostpone($jc$.from(), $jc$.to(), $jc$.match(), $post$)\;
            \label{algorithm:workflow-III-translation:step21}
    }
    \Else{
        $w_D$.addJoin($jc$.from(), $jc$.to(), $jc$.match())\;
        \label{algorithm:workflow-III-translation:stepIV}
    }
}

\tcp{translation of VALUES clauses}
\ForEach{\textup{values statement $vs$ in $qp$}}{
\label{algorithm:workflow-III-translation:stepV}
    processOrPostponeFiltering($w_D$, ('VARIABLE', $vs$.kind(), $vs$.morph(), $vs$.buildPath(), $\epsilon$), 'equal', ('VALUES', $\epsilon$, $\epsilon$, $\epsilon$, $vs$.values()), $post$, 'filteringValues')\;
    \label{algorithm:workflow-III-translation:step25}
}

\tcp{translation of FILTER clauses}
\ForEach{\textup{filter ($lhs$, $op$, $rhs$) in $qp$}}{
    \If{\textup{$lhs$ is VARIABLE}}{
    \label{algorithm:workflow-III-translation:step27}
        processOrPostponeFiltering($w_D$, $lhs$, $op$, $rhs$, $post$, 'filtering')\;
        \label{algorithm:workflow-III-translation:step28}
    }
    \ElseIf{\textup{$lhs$ is AGGREGATION}}{
        $lhsAggregation$ = includeAggregationRoot($lhs$.type(), $lhs$.var(), $lhs$.kind())\;
        
        \If{\textup{$rhs$ is AGGREGATION}}{
        \label{algorithm:workflow-III-translation:step31}
            $rhsAggregation$ = includeAggregationRoot($rhs$.type(), $rhs$.var(), $rhs$.kind())\;
            processOrPostponeFiltering($w_D$, $lhsAggregation$, $op$, $rhsAggregation$, $post$, 'filteringAggregation')\;
            \label{algorithm:workflow-III-translation:step33}
        }
        \Else{
            processOrPostponeFiltering($w_D$, $lhsAggregation$, $op$, $rhs$, $post$, 'filteringAggregation')\;
        }
    }
    \label{algorithm:workflow-III-translation:stepVI}
}

\return{$w_D$.buildDSL()}

\caption{Query Part Translation}
\label{algorithm:workflow-III-translation}
\end{algorithm}